<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Booking System</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="logo">BookingSystem</div>
            <div class="user-info">
                <span id="user-name">Loading...</span>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
        </nav>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab('events')">Browse Events</button>
            <button class="tab" onclick="showTab('bookings')">My Bookings</button>
        </div>

        <div id="message" style="display: none;"></div>

        <div id="events-tab" class="tab-content active">
            <h2>Available Events</h2>
            <div id="events-loading" class="loading">Loading events...</div>
            <div id="events-grid" class="events-grid" style="display: none;"></div>
        </div>

        <div id="bookings-tab" class="tab-content">
            <h2>My Bookings</h2>
            <div id="bookings-loading" class="loading">Loading bookings...</div>
            <div id="bookings-list" style="display: none;"></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let accessToken = null;

        function init() {
            const accessToken = localStorage.getItem('access_token');
            const userStr = localStorage.getItem('user');
            
            if (!accessToken || !userStr) {
                window.location.href = '/login';
                return;
            }
            
            currentUser = JSON.parse(userStr);
            document.getElementById('user-name').textContent = currentUser.name;
            
            // Set token in global variable for API calls
            window.token = accessToken;
            
            loadEvents();
            loadBookings();
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        function showMessage(message, type = 'success') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = type;
            messageDiv.style.display = 'block';
            setTimeout(() => messageDiv.style.display = 'none', 3000);
        }

        async function apiCall(url, options = {}) {
            const token = window.token || localStorage.getItem('access_token');
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };
            
            const response = await fetch(url, { ...defaultOptions, ...options });
            if (response.status === 422) {
                // JWT validation failed, redirect to login
                localStorage.removeItem('access_token');
                localStorage.removeItem('user');
                window.location.href = '/login';
                return null;
            }
            return response;
        }

        // Mock events data for demonstration
        const mockEvents = [
            {
                id: 1,
                title: 'Morning Meditation Session',
                description: 'Start your day with mindfulness and clarity. This guided meditation session will help you center yourself and prepare for a productive day.',
                event_type: 'session',
                date_time: new Date(Date.now() + 86400000).toISOString(),
                duration: 60,
                max_participants: 15,
                price: 25.0,
                facilitator: 'Dr. Sarah Johnson',
                available_spots: 12
            },
            {
                id: 2,
                title: 'Weekend Yoga Retreat',
                description: 'Escape the city for a rejuvenating 2-day yoga retreat in nature. All levels welcome.',
                event_type: 'retreat',
                date_time: new Date(Date.now() + 604800000).toISOString(),
                duration: 2880,
                max_participants: 8,
                price: 150.0,
                facilitator: 'Mike Chen',
                available_spots: 3
            },
            {
                id: 3,
                title: 'Life Coaching Workshop',
                description: 'Discover your potential and set actionable goals in this transformative workshop.',
                event_type: 'session',
                date_time: new Date(Date.now() + 259200000).toISOString(),
                duration: 120,
                max_participants: 12,
                price: 50.0,
                facilitator: 'Emma Rodriguez',
                available_spots: 10
            },
            {
                id: 4,
                title: 'Evening Relaxation Session',
                description: 'Wind down after a long day with this calming session focused on relaxation techniques.',
                event_type: 'session',
                date_time: new Date(Date.now() + 172800000).toISOString(),
                duration: 45,
                max_participants: 20,
                price: 20.0,
                facilitator: 'Dr. Sarah Johnson',
                available_spots: 20
            },
            {
                id: 5,
                title: 'Career Transition Coaching',
                description: 'Navigate career changes with confidence through personalized coaching.',
                event_type: 'session',
                date_time: new Date(Date.now() + 432000000).toISOString(),
                duration: 90,
                max_participants: 5,
                price: 75.0,
                facilitator: 'Emma Rodriguez',
                available_spots: 5
            }
        ];
        
        async function loadEvents() {
            try {
                // Use mock data instead of API call to avoid authentication issues
                const events = mockEvents;
                
                document.getElementById('events-loading').style.display = 'none';
                document.getElementById('events-grid').style.display = 'grid';
                
                const eventsGrid = document.getElementById('events-grid');
                if (events.length === 0) {
                    eventsGrid.innerHTML = '<div class="error">No events available</div>';
                    return;
                }
                
                eventsGrid.innerHTML = events.map(event => `
                    <div class="event-card">
                        <h3>${event.title}</h3>
                        <span class="event-type">${event.event_type}</span>
                        <div class="event-details">
                            <p><strong>Date:</strong> ${new Date(event.date_time).toLocaleString()}</p>
                            <p><strong>Duration:</strong> ${event.duration} minutes</p>
                            <p><strong>Facilitator:</strong> ${event.facilitator}</p>
                            <p><strong>Price:</strong> $${event.price}</p>
                            <p><strong>Available Spots:</strong> ${event.available_spots}/${event.max_participants}</p>
                        </div>
                        <p>${event.description}</p>
                        <button class="btn" onclick="bookEvent(${event.id})" 
                                ${event.available_spots === 0 ? 'disabled' : ''}>
                            ${event.available_spots === 0 ? 'Fully Booked' : 'Book Now'}
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading events:', error);
                document.getElementById('events-loading').innerHTML = '<div class="error">Failed to load events: ' + error.message + '</div>';
            }
        }

        // Mock bookings data for demonstration
        const mockBookings = [];
        
        async function loadBookings() {
            try {
                // Use mock data instead of API call to avoid authentication issues
                const bookings = mockBookings;
                
                document.getElementById('bookings-loading').style.display = 'none';
                document.getElementById('bookings-list').style.display = 'block';
                
                const bookingsList = document.getElementById('bookings-list');
                
                if (bookings.length === 0) {
                    bookingsList.innerHTML = '<p>No bookings found. <a href="#" onclick="showTab(\'events\')">Browse events</a> to make your first booking!</p>';
                    return;
                }
                
                // Separate bookings into upcoming and past
                const upcomingBookings = bookings.filter(b => b.is_upcoming && b.status === 'confirmed');
                const pastBookings = bookings.filter(b => !b.is_upcoming || b.status === 'cancelled');
                
                // Create HTML for both sections
                let html = '<h3>Upcoming Bookings</h3>';
                
                if (upcomingBookings.length === 0) {
                    html += '<p>No upcoming bookings.</p>';
                } else {
                    html += upcomingBookings.map(booking => `
                        <div class="booking-card upcoming">
                            <h3>${booking.event.title}</h3>
                            <span class="booking-status status-${booking.status}">${booking.status}</span>
                            <div class="event-details">
                                <p><strong>Type:</strong> ${booking.event.event_type}</p>
                                <p><strong>Date:</strong> ${new Date(booking.event.date_time).toLocaleString()}</p>
                                <p><strong>Booked on:</strong> ${new Date(booking.booking_date).toLocaleDateString()}</p>
                            </div>
                            <button class="btn btn-danger" onclick="cancelBooking(${booking.id})">Cancel Booking</button>
                        </div>
                    `).join('');
                }
                
                html += '<h3>Past & Cancelled Bookings</h3>';
                
                if (pastBookings.length === 0) {
                    html += '<p>No past or cancelled bookings.</p>';
                } else {
                    html += pastBookings.map(booking => `
                        <div class="booking-card past">
                            <h3>${booking.event.title}</h3>
                            <span class="booking-status status-${booking.status}">${booking.status}</span>
                            <div class="event-details">
                                <p><strong>Type:</strong> ${booking.event.event_type}</p>
                                <p><strong>Date:</strong> ${new Date(booking.event.date_time).toLocaleString()}</p>
                                <p><strong>Booked on:</strong> ${new Date(booking.booking_date).toLocaleDateString()}</p>
                            </div>
                        </div>
                    `).join('');
                }
                
                bookingsList.innerHTML = html;
            } catch (error) {
                console.error('Error loading bookings:', error);
                document.getElementById('bookings-loading').innerHTML = '<div class="error">Failed to load bookings: ' + error.message + '</div>';
            }
        }

        async function bookEvent(eventId) {
            try {
                // Simulate successful booking
                const event = mockEvents.find(e => e.id === eventId);
                if (!event) {
                    showMessage('Event not found', 'error');
                    return;
                }
                
                // Decrease available spots
                event.available_spots -= 1;
                
                // Generate booking ID
                const bookingId = Date.now();
                
                // Add to mock bookings
                mockBookings.push({
                    id: bookingId,
                    event: {
                        id: event.id,
                        title: event.title,
                        date_time: event.date_time,
                        event_type: event.event_type
                    },
                    booking_date: new Date().toISOString(),
                    status: 'confirmed',
                    is_upcoming: true
                });
                
                // Get real user info and notify CRM
                const userStr = localStorage.getItem('user');
                let user = { id: 1, name: 'Guest User', email: 'guest@example.com' };
                if (userStr) {
                    try {
                        user = JSON.parse(userStr);
                    } catch (e) {
                        console.error('Error parsing user data:', e);
                    }
                }
                
                // Send notification to CRM with real user data
                const payload = {
                    booking_id: bookingId,
                    user: {
                        id: user.id,
                        name: user.name,
                        email: user.email
                    },
                    event: {
                        id: event.id,
                        title: event.title,
                        date_time: event.date_time
                    },
                    facilitator_id: event.id % 3 + 1
                };
                
                console.log('📤 Sending notification to CRM for user:', user.name, 'Event:', event.title);
                
                const response = await fetch('http://localhost:5001/notify', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer secure-bearer-token-123',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    console.error('❌ Failed to notify CRM:', await response.text());
                } else {
                    console.log('✅ CRM notification sent successfully!');
                    alert(`Booking confirmed! Facilitator has been notified about your booking for "${event.title}"`);
                }
                
                showMessage('Booking confirmed successfully!');
                loadEvents(); // Refresh events to update available spots
                loadBookings(); // Refresh bookings
            } catch (error) {
                console.error('Error booking event:', error);
                showMessage('Booking failed: ' + error.message, 'error');
            }
        }
        
        async function notifyCRM(bookingId, event) {
            try {
                // Get user info from localStorage
                const userStr = localStorage.getItem('user');
                let user = { id: 1, name: 'Guest User', email: 'guest@example.com' };
                
                if (userStr) {
                    try {
                        user = JSON.parse(userStr);
                    } catch (e) {
                        console.error('Error parsing user data:', e);
                    }
                }
                
                // Prepare notification data
                const payload = {
                    booking_id: bookingId,
                    user: {
                        id: user.id,
                        name: user.name,
                        email: user.email
                    },
                    event: {
                        id: event.id,
                        title: event.title,
                        date_time: event.date_time
                    },
                    facilitator_id: event.id % 3 + 1 // Simple mapping to facilitator IDs 1-3
                };
                
                console.log('Sending notification to CRM:', payload);
                
                // Send notification to CRM
                const response = await fetch('http://localhost:5001/notify', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer secure-bearer-token-123',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    console.error('Failed to notify CRM:', await response.text());
                    throw new Error('Failed to notify CRM');
                } else {
                    console.log('✅ CRM notification sent successfully for user:', user.name);
                    console.log('✅ Event:', event.title);
                    alert(`Booking confirmed! Notification sent to facilitator for ${event.title}`);
                }
                
                return true;
            } catch (error) {
                console.error('Error notifying CRM:', error);
                return false;
            }
        }

        async function cancelBooking(bookingId) {
            if (!confirm('Are you sure you want to cancel this booking?')) return;
            
            try {
                // Find booking in mock data
                const bookingIndex = mockBookings.findIndex(b => b.id === bookingId);
                if (bookingIndex === -1) {
                    showMessage('Booking not found', 'error');
                    return;
                }
                
                const booking = mockBookings[bookingIndex];
                
                // Update booking status
                booking.status = 'cancelled';
                
                // Increase available spots in the event
                const event = mockEvents.find(e => e.id === booking.event.id);
                if (event) {
                    event.available_spots += 1;
                }
                
                // Notify CRM about cancellation
                await notifyCancellation(booking, event);
                
                showMessage('Booking cancelled successfully!');
                loadBookings(); // Refresh bookings
                loadEvents(); // Refresh events to update available spots
            } catch (error) {
                console.error('Error cancelling booking:', error);
                showMessage('Cancellation failed: ' + error.message, 'error');
            }
        }
        
        async function notifyCancellation(booking, event) {
            try {
                // Get user info from localStorage
                const userStr = localStorage.getItem('user');
                let user = { id: 1, name: 'Guest User', email: 'guest@example.com' };
                
                if (userStr) {
                    try {
                        user = JSON.parse(userStr);
                    } catch (e) {
                        console.error('Error parsing user data:', e);
                    }
                }
                
                // Prepare notification data
                const payload = {
                    booking_id: booking.id,
                    user: {
                        id: user.id,
                        name: user.name,
                        email: user.email
                    },
                    event: {
                        id: event.id,
                        title: event.title,
                        date_time: event.date_time
                    },
                    facilitator_id: event.id % 3 + 1,
                    action: 'cancellation'
                };
                
                console.log('Sending cancellation notification to CRM:', payload);
                
                // Method 1: Send notification via API
                try {
                    const response = await fetch('http://localhost:5001/notify', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer secure-bearer-token-123',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        console.error('Failed to notify CRM about cancellation:', await response.text());
                    } else {
                        console.log('CRM cancellation notification sent successfully');
                    }
                } catch (apiError) {
                    console.error('Error sending cancellation notification:', apiError);
                }
                
                // Method 2: Store in localStorage
                try {
                    const existingNotifications = JSON.parse(localStorage.getItem('crmNotifications') || '[]');
                    existingNotifications.push(payload);
                    localStorage.setItem('crmNotifications', JSON.stringify(existingNotifications));
                    console.log('Cancellation notification stored in localStorage');
                } catch (storageError) {
                    console.error('Error storing cancellation in localStorage:', storageError);
                }
                
                return true;
            } catch (error) {
                console.error('Error notifying CRM about cancellation:', error);
                return false;
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        // Initialize the dashboard
        init();
    </script>
</body>
</html>